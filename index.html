<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>í•™ê¸‰ ì ìˆ˜íŒ (í•™ìƒìš©)</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; padding: 20px; background: #f9fafb; }
h1,h2{margin-bottom:16px;}
ul{list-style:none;padding:0;}
li{margin:12px 0;}
button.link-btn{
  background:none;border:none;color:#2563eb;
  font-size:18px;cursor:pointer;padding:0;
}
button.link-btn:hover{text-decoration:underline;}

.rank-badge{margin-left:8px;font-weight:bold;}
.rank-1{color:#ca8a04;}
.rank-2{color:#6b7280;}
.rank-3{color:#92400e;}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:14px;
  max-width:1000px;
}
.card{
  background:#fff;border:1px solid #ddd;
  border-radius:10px;padding:12px;
}
.class-name{font-weight:bold;color:#2563eb;}
.points{float:right;font-weight:bold;}
.reasons{
  margin-top:10px;
  max-height:160px;
  overflow-y:auto;
  background:#f9fafb;
  border:1px solid #ddd;
  padding:8px;
  border-radius:8px;
}
.reason{font-size:14px;margin-bottom:6px;}
.reason-time{font-size:12px;color:#555;}
</style>
</head>

<body>

<div id="home">
  <h1>í•™ë…„ ì„ íƒ</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};
let currentGrade = null;

/* =========================
   ğŸ† RANK LOGIC (STRICT)
========================= */
function getRanks(classesObj) {
  if (!classesObj) return [];

  const valid = Object.entries(classesObj)
    .map(([name, data]) => ({
      name,
      points: data.points || 0
    }))
    .filter(c => c.points > 0);

  // ğŸ”´ ABSOLUTE STOP: no points, no badges
  if (valid.length === 0) return [];

  valid.sort((a,b)=>b.points-a.points);

  const grouped = {};
  valid.forEach(c=>{
    grouped[c.points] = grouped[c.points] || [];
    grouped[c.points].push(c.name);
  });

  const scores = Object.keys(grouped)
    .map(Number)
    .sort((a,b)=>b-a)
    .slice(0,3);

  return scores.map((score,i)=>({
    rank: i+1,
    classes: grouped[score]
  }));
}

/* =========================
   ğŸ“¡ DATA
========================= */
db.ref("grades").on("value", snap=>{
  grades = snap.val() || {};
  currentGrade ? renderGrade(currentGrade) : renderHome();
});

/* =========================
   ğŸ  HOME
========================= */
function renderHome(){
  currentGrade=null;
  document.getElementById("view").innerHTML="";
  document.getElementById("home").style.display="block";

  const ul=document.getElementById("grade-links");
  ul.innerHTML="";

  for(const grade in grades){
    const li=document.createElement("li");
    li.innerHTML=`<button class="link-btn" data-grade="${grade}">${grade}</button>`;

    const ranks=getRanks(grades[grade]);

    // âœ… badges only rendered if ranks exist
    ranks.forEach(r=>{
      const label =
        r.rank===1?"ğŸ¥‡ ê³µë™ 1ë“±":
        r.rank===2?"ğŸ¥ˆ ê³µë™ 2ë“±":
        "ğŸ¥‰ ê³µë™ 3ë“±";

      r.classes.forEach(cls=>{
        const span=document.createElement("span");
        span.className=`rank-badge rank-${r.rank}`;
        span.textContent=` ${label} (${cls})`;
        li.appendChild(span);
      });
    });

    ul.appendChild(li);
  }
}

/* =========================
   ğŸ“Š GRADE PAGE
========================= */
function renderGrade(grade){
  currentGrade=grade;
  document.getElementById("home").style.display="none";

  const view=document.getElementById("view");
  view.innerHTML=`
    <button class="link-btn" id="back">â† ëŒì•„ê°€ê¸°</button>
    <h2>${grade} ì ìˆ˜</h2>
    <div class="grid"></div>
  `;

  const grid=view.querySelector(".grid");
  const classes=grades[grade]||{};

  for(const name in classes){
    const d=classes[name];
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div>
        <span class="class-name">${name}</span>
        <span class="points">${d.points||0}</span>
      </div>
      <div class="reasons"></div>
    `;

    const reasons=card.querySelector(".reasons");
    (d.reasons||[]).slice().reverse().forEach(r=>{
      const div=document.createElement("div");
      div.className="reason";
      div.innerHTML=`
        ${r.text}
        <div class="reason-time">${r.time}</div>
      `;
      reasons.appendChild(div);
    });

    grid.appendChild(card);
  }
}

/* =========================
   EVENTS
========================= */
document.addEventListener("click",e=>{
  if(e.target.dataset.grade) renderGrade(e.target.dataset.grade);
  if(e.target.id==="back") renderHome();
});
</script>

</body>
</html>
