<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í•™ê¸‰ ì ìˆ˜íŒ (í•™ìƒìš©)</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(#cfe9ff, #eaf6ff);
  color: #0f172a;
}

h1, h2 { margin-bottom: 12px; }
ul { list-style: none; padding: 0; }
li { margin-bottom: 18px; }

.link-btn {
  background: none;
  border: none;
  font-size: 20px;
  font-weight: bold;
  color: #2563eb;
  cursor: pointer;
}

.rank-line {
  margin-left: 12px;
  font-weight: bold;
  text-shadow: 1px 1px 2px #000;
}

.rank-1 { color: gold; }
.rank-2 { color: silver; }
.rank-3 { color: peru; }

#home, #view { padding: 16px; }

.back-btn {
  background: none;
  border: none;
  color: #2563eb;
  cursor: pointer;
}

.total-score {
  font-size: 26px;
  font-weight: bold;
  color: gold;
  text-shadow: 1px 1px 2px #000;
  margin: 10px 0;
}

.reasons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
  max-height: 210px;
  overflow-y: auto;
}

.reason-card {
  background: #fff;
  padding: 12px;
  border-radius: 10px;
  font-weight: bold;
}

.plus { border-left: 6px solid green; }
.minus { border-left: 6px solid red; }

.reason-time {
  font-size: 12px;
  color: #555;
}
</style>
</head>

<body>

<div id="home">
  <h1>í•™ë…„ ì„ íƒ</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2"
});

const db = firebase.database();
let grades = {};

db.ref("grades").on("value", snap => {
  grades = snap.val() || {};
  renderHome();
});

function renderHome() {
  const ul = document.getElementById("grade-links");
  ul.innerHTML = "";
  document.getElementById("view").innerHTML = "";

  for (const grade in grades) {
    const gradeData = grades[grade];
    if (!gradeData || typeof gradeData !== "object") continue;

    const li = document.createElement("li");

    const btn = document.createElement("button");
    btn.className = "link-btn";
    btn.textContent = grade;
    btn.onclick = () => openGrade(grade);
    li.appendChild(btn);

    const scored = Object.entries(gradeData)
      .filter(([_, d]) => d && typeof d === "object")
      .map(([n, d]) => ({ name: n, points: d.points || 0 }))
      .filter(c => c.points > 0);

    const groups = {};
    scored.forEach(c => {
      groups[c.points] = groups[c.points] || [];
      groups[c.points].push(c.name);
    });

    Object.keys(groups)
      .map(Number)
      .sort((a, b) => b - a)
      .slice(0, 3)
      .forEach((score, i) => {
        const line = document.createElement("div");
        line.className = `rank-line rank-${i + 1}`;
        line.textContent = `ğŸ… ${i + 1}ë“±: ${groups[score].join(", ")}`;
        li.appendChild(line);
      });

    ul.appendChild(li);
  }
}

function openGrade(grade) {
  document.getElementById("home").style.display = "none";
  const view = document.getElementById("view");
  view.innerHTML = `<button class="back-btn" onclick="location.reload()">â† ëŒì•„ê°€ê¸°</button><h2>${grade}</h2>`;

  const classes = grades[grade] || {};
  for (const cls in classes) {
    renderClass(view, cls, classes[cls]);
  }
}

function renderClass(parent, cls, data) {
  if (!data) return;

  const wrap = document.createElement("div");

  const total = document.createElement("div");
  total.className = "total-score";
  total.textContent = `${cls}: ${data.points || 0}`;
  wrap.appendChild(total);

  const grid = document.createElement("div");
  grid.className = "reasons-grid";

  const reasons = data.reasons ? Object.values(data.reasons) : [];
  reasons.reverse().forEach(r => {
    const card = document.createElement("div");
    card.className = "reason-card " + (r.text?.includes("+") ? "plus" : "minus");
    card.innerHTML = `${r.text || ""}<div class="reason-time">${r.time || ""}</div>`;
    grid.appendChild(card);
  });

  wrap.appendChild(grid);
  parent.appendChild(wrap);
}
</script>

</body>
</html>
