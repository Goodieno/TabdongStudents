<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÌïôÍ∏â Ï†êÏàòÌåê (ÌïôÏÉùÏö©)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 14px;
  background: #f9fafb;
}

h1, h2 {
  margin-bottom: 14px;
  font-size: clamp(20px, 4vw, 28px);
}

ul { list-style: none; padding: 0; }

li {
  margin: 14px 0;
  line-height: 1.6;
}

/* Links */
button.link-btn {
  background: none;
  border: none;
  color: #2563eb;
  font-size: 18px;
  cursor: pointer;
  padding: 8px 4px;
}
button.link-btn:hover { text-decoration: underline; }

/* Rank badges */
.rank-badge {
  display: inline-block;
  margin: 6px 6px 0 0;
  font-weight: bold;
  white-space: nowrap;
}
.rank-1 { color: #ca8a04; }
.rank-2 { color: #6b7280; }
.rank-3 { color: #92400e; }

/* ‚úÖ GRID ‚Äî MAX 3 COLUMNS */
.grid {
  display: grid;
  gap: 14px;
  grid-template-columns: repeat(1, 1fr);
}

@media (min-width: 600px) {
  .grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (min-width: 1000px) {
  .grid {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}

/* Cards */
.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 14px;
}

.class-name {
  font-weight: bold;
  color: #2563eb;
  font-size: 18px;
}

/* ‚≠ê TOTAL POINTS */
.points {
  float: right;
  font-weight: bold;
  font-size: 20px;
  color: #facc15;
  -webkit-text-stroke: 1px #000;
  text-shadow: 1px 1px 0 #000;
}

/* Reasons box */
.reasons {
  margin-top: 10px;
  max-height: 180px;
  overflow-y: auto;
  background: #f9fafb;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 10px;
}

/* Reason entries */
.reason {
  font-size: 15px;
  margin-bottom: 8px;
  font-weight: bold;
}

.reason.plus { color: #15803d; }
.reason.minus { color: #b91c1c; }

.reason-time {
  font-size: 12px;
  color: #555;
  font-weight: normal;
}

/* Mobile fix */
@media (max-width: 480px) {
  .points {
    float: none;
    display: block;
    margin-top: 4px;
  }
}
</style>
</head>

<body>

<div id="home">
  <h1>ÌïôÎÖÑ ÏÑ†ÌÉù</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};
let currentGrade = null;

/* ===== RANK LOGIC ===== */
function getRanks(classesObj) {
  if (!classesObj) return [];

  const valid = Object.entries(classesObj)
    .map(([name, data]) => ({ name, points: data.points || 0 }))
    .filter(c => c.points > 0);

  if (valid.length === 0) return [];

  valid.sort((a,b)=>b.points-a.points);

  const grouped = {};
  valid.forEach(c=>{
    grouped[c.points] = grouped[c.points] || [];
    grouped[c.points].push(c.name);
  });

  const scores = Object.keys(grouped)
    .map(Number)
    .sort((a,b)=>b-a)
    .slice(0,3);

  return scores.map((score,i)=>({
    rank: i+1,
    classes: grouped[score]
  }));
}

/* ===== DATA ===== */
db.ref("grades").on("value", snap=>{
  grades = snap.val() || {};
  currentGrade ? renderGrade(currentGrade) : renderHome();
});

/* ===== HOME ===== */
function renderHome(){
  currentGrade = null;
  document.getElementById("view").innerHTML="";
  document.getElementById("home").style.display="block";

  const ul = document.getElementById("grade-links");
  ul.innerHTML="";

  for(const grade in grades){
    const li=document.createElement("li");
    li.innerHTML=`<button class="link-btn" data-grade="${grade}">${grade}</button>`;

    const ranks = getRanks(grades[grade]);
    ranks.forEach(r=>{
      const label =
        r.rank===1?"ü•á Í≥µÎèô 1Îì±":
        r.rank===2?"ü•à Í≥µÎèô 2Îì±":
        "ü•â Í≥µÎèô 3Îì±";

      r.classes.forEach(cls=>{
        const span=document.createElement("span");
        span.className=`rank-badge rank-${r.rank}`;
        span.textContent=` ${label} (${cls})`;
        li.appendChild(span);
      });
    });

    ul.appendChild(li);
  }
}

/* ===== GRADE PAGE ===== */
function renderGrade(grade){
  currentGrade = grade;
  document.getElementById("home").style.display="none";

  const view = document.getElementById("view");
  view.innerHTML=`
    <button class="link-btn" id="back">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    <h2>${grade} Ï†êÏàò</h2>
    <div class="grid"></div>
  `;

  const grid = view.querySelector(".grid");
  const classes = grades[grade] || {};

  for(const name in classes){
    const d = classes[name];
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div>
        <span class="class-name">${name}</span>
        <span class="points">${d.points||0}</span>
      </div>
      <div class="reasons"></div>
    `;

    const reasons = card.querySelector(".reasons");
    (d.reasons||[]).slice().reverse().forEach(r=>{
      const div=document.createElement("div");

      const isPlus = r.text.includes("+2");
      const isMinus = r.text.includes("-1");

      div.className = "reason " + (isPlus ? "plus" : isMinus ? "minus" : "");
      div.innerHTML = `
        ${r.text}
        <div class="reason-time">${r.time}</div>
      `;
      reasons.appendChild(div);
    });

    grid.appendChild(card);
  }
}

/* ===== EVENTS ===== */
document.addEventListener("click",e=>{
  if(e.target.dataset.grade) renderGrade(e.target.dataset.grade);
  if(e.target.id==="back") renderHome();
});
</script>

</body>
</html>
