<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÌïôÍ∏â Ï†êÏàòÌåê (ÌïôÏÉùÏö©)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ===== BASE ===== */
body {
  font-family: Arial, sans-serif;
  padding: 14px;
  background: linear-gradient(#e8f2ff, #f9fafb);
  overflow-x: hidden;
}

h1, h2 {
  margin-bottom: 14px;
  font-size: clamp(20px, 4vw, 28px);
}

ul { list-style: none; padding: 0; }
li { margin: 16px 0; }

/* ===== LINKS ===== */
button.link-btn {
  background: none;
  border: none;
  color: #2563eb;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 0;
}
button.link-btn:hover { text-decoration: underline; }

/* ===== RANK BADGES ===== */
.rank-line {
  margin-left: 6px;
  font-weight: bold;
  line-height: 1.5;
}

.rank-1 { color: #ca8a04; }
.rank-2 { color: #6b7280; }
.rank-3 { color: #92400e; }

/* ===== GRID (MAX 3) ===== */
.grid {
  display: grid;
  gap: 14px;
  grid-template-columns: repeat(1, 1fr);
}
@media (min-width: 600px) {
  .grid { grid-template-columns: repeat(2, 1fr); }
}
@media (min-width: 900px) {
  .grid { grid-template-columns: repeat(3, 1fr); }
}

/* ===== CARD ===== */
.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 14px;
}

/* ===== CLASS HEADER ===== */
.total-score {
  margin-bottom: 8px;
}

.class-label {
  color: #000;
  font-weight: bold;
  font-size: 18px;
  margin-right: 6px;
}

.class-points {
  font-size: 26px;
  font-weight: bold;
  color: #facc15;
  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000;
}

/* ===== REASONS ===== */
.reasons {
  max-height: 120px;        /* shows ~3 */
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: #f9fafb;
  padding: 10px;
}

.reason {
  font-size: 15px;
  font-weight: bold;
  margin-bottom: 8px;
}

.reason.plus { color: #15803d; }
.reason.minus { color: #b91c1c; }

.reason-time {
  font-size: 12px;
  color: #555;
  font-weight: normal;
}

/* ===== SNOW ===== */
.snowflake {
  position: fixed;
  top: -10px;
  color: #ffffff;
  font-size: 16px;
  opacity: 0.9;
  pointer-events: none;
  animation: fall linear infinite;
}

@keyframes fall {
  to {
    transform: translateY(110vh);
  }
}
</style>
</head>

<body>

<div id="home">
  <h1>ÌïôÎÖÑ ÏÑ†ÌÉù</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};
let currentGrade = null;

/* ===== DATA ===== */
db.ref("grades").on("value", snap => {
  grades = snap.val() || {};
  currentGrade ? renderGrade(currentGrade) : renderHome();
});

/* ===== HOME ===== */
function renderHome() {
  currentGrade = null;
  document.getElementById("view").innerHTML = "";
  document.getElementById("home").style.display = "block";

  const ul = document.getElementById("grade-links");
  ul.innerHTML = "";

  for (const grade in grades) {
    const li = document.createElement("li");
    li.innerHTML = `<button class="link-btn" data-grade="${grade}">${grade}</button>`;

    const classes = grades[grade];
    const scored = Object.entries(classes)
      .map(([n,d]) => ({ n, p: d.points||0 }))
      .filter(c => c.p > 0);

    if (scored.length) {
      scored.sort((a,b)=>b.p-a.p);
      const grouped = {};
      scored.forEach(c=>{
        grouped[c.p] = grouped[c.p] || [];
        grouped[c.p].push(c.n);
      });

      Object.keys(grouped).sort((a,b)=>b-a).slice(0,3).forEach((score,i)=>{
        const rank = i+1;
        const tie = grouped[score].length > 1;
        const medal = rank===1?"ü•á":rank===2?"ü•à":"ü•â";
        const label = tie ? `${medal}ü•ä Í≥µÎèô ${rank}Îì±` : `${medal} ${rank}Îì±`;

        const div = document.createElement("div");
        div.className = `rank-line rank-${rank}`;
        div.textContent = `${label}: ${grouped[score].join(", ")}`;
        li.appendChild(div);
      });
    }

    ul.appendChild(li);
  }
}

/* ===== GRADE PAGE ===== */
function renderGrade(grade) {
  currentGrade = grade;
  document.getElementById("home").style.display = "none";

  const view = document.getElementById("view");
  view.innerHTML = `
    <button class="link-btn" id="back">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    <h2>${grade} Ï†êÏàò</h2>
    <div class="grid"></div>
  `;

  const grid = view.querySelector(".grid");
  const classes = grades[grade] || {};

  for (const cls in classes) {
    const d = classes[cls];
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="total-score">
        <span class="class-label">${cls}</span>
        <span class="class-points">${d.points||0}</span>
      </div>
      <div class="reasons"></div>
    `;

    const reasons = card.querySelector(".reasons");
    (d.reasons||[]).slice().reverse().forEach(r=>{
      const div = document.createElement("div");
      div.className = "reason " + (r.text.includes("+2")?"plus":"minus");
      div.innerHTML = `${r.text}<div class="reason-time">${r.time}</div>`;
      reasons.appendChild(div);
    });

    grid.appendChild(card);
  }
}

/* ===== EVENTS ===== */
document.addEventListener("click", e => {
  if (e.target.dataset.grade) renderGrade(e.target.dataset.grade);
  if (e.target.id === "back") renderHome();
});

/* ===== SNOW GENERATOR ===== */
setInterval(()=>{
  const flake=document.createElement("div");
  flake.className="snowflake";
  flake.textContent="‚ùÑ";
  flake.style.left=Math.random()*100+"vw";
  flake.style.animationDuration=8+Math.random()*6+"s";
  document.body.appendChild(flake);
  setTimeout(()=>flake.remove(),15000);
},300);
</script>

</body>
</html>
