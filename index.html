<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÌïôÍ∏â Ï†êÏàòÌåê (ÌïôÏÉùÏö©)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ===== BASE ===== */
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: linear-gradient(#cfe9ff, #eaf6ff);
  color: #0f172a;
  overflow-x: hidden;
}

h1, h2 {
  margin-bottom: 12px;
}

ul {
  list-style: none;
  padding: 0;
}

li {
  margin-bottom: 18px;
}

/* ===== LINKS ===== */
.link-btn {
  background: none;
  border: none;
  font-size: 20px;
  font-weight: bold;
  color: #2563eb;
  cursor: pointer;
}

/* ===== RANK LINES ===== */
.rank-line {
  margin-left: 12px;
  margin-top: 4px;
  font-weight: bold;
}

/* ===== VIEW ===== */
#home {
  padding: 16px;
}

#view {
  padding: 16px;
}

.back-btn {
  background: none;
  border: none;
  color: #2563eb;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 8px;
}

/* ===== TOTAL POINTS ===== */
.total-score {
  font-size: 26px;
  font-weight: bold;
  color: #facc15;
  text-shadow:
    -1px -1px 0 #000,
     1px -1px 0 #000,
    -1px  1px 0 #000,
     1px  1px 0 #000;
  margin: 12px 0;
}

/* ===== REASONS GRID ===== */
.reasons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 12px;
  max-width: 900px;
}

@media (min-width: 900px) {
  .reasons-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* ===== REASON WINDOW (LIMIT = 3) ===== */
.reasons-window {
  max-height: 210px;          /* fits ~3 cards */
  overflow-y: auto;
  padding-right: 4px;
}

/* ===== REASON CARDS ===== */
.reason-card {
  background: #ffffffcc;
  border-radius: 12px;
  padding: 10px;
  margin-bottom: 8px;
  font-weight: bold;
}

.reason-card.plus {
  border-left: 6px solid #16a34a;
  color: #166534;
}

.reason-card.minus {
  border-left: 6px solid #dc2626;
  color: #7f1d1d;
}

.reason-time {
  font-size: 12px;
  font-weight: normal;
  margin-top: 4px;
  color: #475569;
}

/* ===== SNOW ===== */
.snowflake {
  position: fixed;
  top: -10px;
  color: rgba(255,255,255,0.75);
  font-size: 16px;
  animation: fall linear infinite;
  pointer-events: none;
}

@keyframes fall {
  to {
    transform: translateY(110vh);
  }
}
</style>
</head>

<body>

<div id="home">
  <h1>ÌïôÎÖÑ ÏÑ†ÌÉù</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};

/* ===== DATA ===== */
db.ref("grades").on("value", snap => {
  grades = snap.val() || {};
  renderHome();
});

/* ===== HOME ===== */
function renderHome() {
  document.getElementById("view").innerHTML = "";
  document.getElementById("home").style.display = "block";

  const ul = document.getElementById("grade-links");
  ul.innerHTML = "";

  for (const grade in grades) {
    const li = document.createElement("li");

    const btn = document.createElement("button");
    btn.className = "link-btn";
    btn.textContent = grade;
    btn.onclick = () => openGrade(grade);
    li.appendChild(btn);

    const classes = grades[grade] || {};
    const scored = Object.entries(classes)
      .map(([n,d]) => ({ name:n, points:d.points||0 }))
      .filter(c => c.points > 0)
      .sort((a,b)=>b.points-a.points);

    const groups = {};
    scored.forEach(c=>{
      groups[c.points] = groups[c.points] || [];
      groups[c.points].push(c.name);
    });

    Object.keys(groups).slice(0,3).forEach((score,i)=>{
      const rank=i+1;
      const tied = groups[score].length>1;
      const medal = rank===1?"ü•á":rank===2?"ü•à":"ü•â";
      const line=document.createElement("div");
      line.className="rank-line";
      line.textContent = tied
        ? `${medal}ü•ä Í≥µÎèô ${rank}Îì±: ${groups[score].join(", ")}`
        : `${medal} ${rank}Îì±: ${groups[score].join(", ")}`;
      li.appendChild(line);
    });

    ul.appendChild(li);
  }
}

/* ===== GRADE VIEW ===== */
function openGrade(grade) {
  document.getElementById("home").style.display = "none";

  const view = document.getElementById("view");
  view.innerHTML = `
    <button class="back-btn" onclick="renderHome()">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    <h2>${grade} Ï†êÏàò</h2>
  `;

  const classes = grades[grade] || {};
  for (const cls in classes) {
    renderClass(view, cls, classes[cls]);
  }
}

/* ===== CLASS ===== */
function renderClass(parent, cls, data) {
  const wrap = document.createElement("div");

  const total = document.createElement("div");
  total.className="total-score";
  total.textContent = `${cls}: ${data.points||0}`;
  wrap.appendChild(total);

  const grid = document.createElement("div");
  grid.className="reasons-grid";

  const windowDiv = document.createElement("div");
  windowDiv.className="reasons-window";

  (data.reasons||[]).slice().reverse().forEach(r=>{
    const card=document.createElement("div");
    const isPlus = r.text.includes("+2");
    const isMinus = r.text.includes("-1");

    card.className="reason-card " + (isPlus?"plus":isMinus?"minus":"");
    card.innerHTML = `
      ${r.text}
      <div class="reason-time">${r.time||""}</div>
    `;
    windowDiv.appendChild(card);
  });

  grid.appendChild(windowDiv);
  wrap.appendChild(grid);
  parent.appendChild(wrap);
}

/* ===== WINTER SNOW ===== */
const m = new Date().getMonth();
if (m === 11 || m <= 1) {
  for (let i=0;i<40;i++){
    const s=document.createElement("div");
    s.className="snowflake";
    s.textContent="‚ùÑ";
    s.style.left=Math.random()*100+"vw";
    s.style.fontSize=(12+Math.random()*10)+"px";
    s.style.animationDuration=(14+Math.random()*12)+"s";
    s.style.opacity=0.7;
    document.body.appendChild(s);
  }
}
</script>

</body>
</html>
