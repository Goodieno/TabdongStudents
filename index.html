<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í•™ê¸‰ ì ìˆ˜íŒ (í•™ìƒìš©)</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  background: #f1f5f9;
  color: #0f172a;
}

#home, #view {
  padding: 16px;
  max-width: 480px;
  margin: auto;
}

h1, h2 {
  text-align: center;
  font-weight: 800;
}

ul { list-style: none; padding: 0; }

li {
  background: white;
  border-radius: 18px;
  padding: 16px;
  margin-bottom: 14px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}

.link-btn {
  width: 100%;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 16px;
  padding: 14px;
  font-size: 20px;
  font-weight: bold;
}

.rank-line {
  margin-top: 8px;
  font-size: 15px;
}

.rank-1 { color: #ca8a04; }
.rank-2 { color: #64748b; }
.rank-3 { color: #92400e; }

.back-btn {
  background: none;
  border: none;
  color: #2563eb;
  font-size: 16px;
  margin-bottom: 8px;
}

.total-score {
  background: #0f172a;
  color: #facc15;
  border-radius: 20px;
  padding: 18px;
  text-align: center;
  font-size: 30px;
  margin-bottom: 12px;
}

.reasons-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  max-height: 240px;
  overflow-y: auto;
}

.reason-card {
  background: white;
  border-radius: 14px;
  padding: 14px;
}

.reason-card.plus {
  background: #ecfdf5;
  color: #065f46;
}

.reason-card.minus {
  background: #fef2f2;
  color: #7f1d1d;
}

.reason-time {
  font-size: 12px;
  opacity: 0.7;
  margin-top: 4px;
}
</style>
</head>

<body>

<div id="home">
  <h1>í•™ë…„ ì„ íƒ</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
});

const db = firebase.database();
let grades = {};

db.ref("grades").on("value", snap => {
  grades = snap.val() || {};
  renderHome();
});

function renderHome() {
  view.innerHTML = "";
  home.style.display = "block";
  grade-links.innerHTML = "";

  for (const grade in grades) {
    const li = document.createElement("li");
    const btn = document.createElement("button");
    btn.className = "link-btn";
    btn.textContent = grade;
    btn.onclick = () => openGrade(grade);
    li.appendChild(btn);

    const ranked = Object.entries(grades[grade])
      .map(([n,d]) => ({name:n, points:d.points||0}))
      .filter(c=>c.points>0)
      .sort((a,b)=>b.points-a.points);

    const groups = {};
    ranked.forEach(c=>{
      groups[c.points] = groups[c.points] || [];
      groups[c.points].push(c.name);
    });

    Object.keys(groups).map(Number).sort((a,b)=>b-a).slice(0,3)
    .forEach((score,i)=>{
      const line = document.createElement("div");
      line.className = `rank-line rank-${i+1}`;
      line.textContent = `${["ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰"][i]} ${i+1}ë“±: ${groups[score].join(", ")}`;
      li.appendChild(line);
    });

    grade-links.appendChild(li);
  }
}

function openGrade(grade) {
  home.style.display = "none";
  view.innerHTML = `<button class="back-btn" onclick="renderHome()">â† ëŒì•„ê°€ê¸°</button><h2>${grade}</h2>`;
  Object.entries(grades[grade]||{}).forEach(([cls,data])=>renderClass(view,cls,data));
}

function renderClass(parent, cls, data) {
  const wrap = document.createElement("div");
  wrap.innerHTML = `<div class="total-score">${cls}: ${data.points||0}</div>`;
  const grid = document.createElement("div");
  grid.className = "reasons-grid";

  (data.reasons||[]).slice().reverse().forEach(r=>{
    const card = document.createElement("div");
    card.className = "reason-card " + (r.text.includes("+")?"plus":r.text.includes("-")?"minus":"");
    card.innerHTML = `${r.text}<div class="reason-time">${r.time||""}</div>`;
    grid.appendChild(card);
  });

  wrap.appendChild(grid);
  parent.appendChild(wrap);
}
</script>
</body>
</html>
