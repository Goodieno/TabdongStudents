<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>학급 점수판</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 14px;
  background: #f9fafb;
}

h1, h2 {
  margin-bottom: 14px;
}

/* ✅ GRID — MAX 3 COLUMNS */
.grid {
  display: grid;
  gap: 14px;
  max-width: 1100px;
  margin: 0 auto;
  grid-template-columns: repeat(3, minmax(0, 1fr));
}

/* Tablet */
@media (max-width: 900px) {
  .grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* Mobile */
@media (max-width: 520px) {
  .grid {
    grid-template-columns: 1fr;
  }
}

.card {
  background: #ffffff;
  border: 1px solid #ddd;
  border-radius: 12px;
  padding: 12px;
}

.class-name {
  font-weight: bold;
  color: #2563eb;
  font-size: 18px;
}

/* ✅ TOTAL POINTS */
.points {
  float: right;
  font-weight: 900;
  font-size: 22px;
  color: #fde047;
  -webkit-text-stroke: 1.5px black;
  text-stroke: 1.5px black;
}

/* BADGES */
.badge {
  display: inline-block;
  margin-left: 6px;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: bold;
  color: white;
}
.badge.gold { background: #f59e0b; }
.badge.silver { background: #9ca3af; }
.badge.bronze { background: #d97706; }

/* REASONS */
.reasons-wrapper {
  margin-top: 10px;
  max-height: 160px;
  overflow-y: auto;
  border: 1px solid #ddd;
  padding: 8px;
  border-radius: 8px;
  background: #f9fafb;
}

.reason-entry {
  font-size: 14px;
  margin-bottom: 6px;
  padding-bottom: 6px;
  border-bottom: 1px dashed #ccc;
}
.reason-entry:last-child {
  border-bottom: none;
}

.reason-add {
  color: #15803d;
  font-weight: bold;
}

.reason-take {
  color: #b91c1c;
  font-weight: bold;
}

.reason-time {
  font-size: 12px;
  color: #555;
}
</style>
</head>

<body>

<div id="home">
  <h1>학년 선택</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};
let currentGrade = null;

db.ref("grades").on("value", snapshot => {
  grades = snapshot.val() || {};
  currentGrade ? renderGrade(currentGrade) : renderHome();
});

function renderHome() {
  const ul = document.getElementById("grade-links");
  ul.innerHTML = "";
  document.getElementById("view").innerHTML = "";

  Object.keys(grades).forEach(grade => {
    const li = document.createElement("li");
    const btn = document.createElement("button");
    btn.className = "link-btn";
    btn.textContent = grade;
    btn.onclick = () => {
      currentGrade = grade;
      renderGrade(grade);
    };
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

function renderGrade(gradeName) {
  const view = document.getElementById("view");
  view.innerHTML = `<h2>${gradeName}</h2><div class="grid"></div>`;
  const grid = view.querySelector(".grid");

  const classes = Object.entries(grades[gradeName] || {})
    .map(([name, data]) => ({
      name,
      points: data.points || 0,
      reasons: data.reasons || []
    }));

  const ranked = classes
    .filter(c => c.points > 0)
    .sort((a, b) => b.points - a.points);

  const ranks = {};
  let rank = 1;
  ranked.forEach((c, i) => {
    if (i > 0 && c.points < ranked[i - 1].points) rank = i + 1;
    ranks[c.name] = rank;
  });

  classes.forEach(c => {
    const card = document.createElement("div");
    card.className = "card";

    let badge = "";
    if (ranks[c.name] === 1) badge = `<span class="badge gold">1위</span>`;
    else if (ranks[c.name] === 2) badge = `<span class="badge silver">2위</span>`;
    else if (ranks[c.name] === 3) badge = `<span class="badge bronze">3위</span>`;

    card.innerHTML = `
      <div class="class-name">
        ${c.name}
        <span class="points">${c.points}</span>
        ${badge}
      </div>
      <div class="reasons-wrapper">
        ${c.reasons.map(r => `
          <div class="reason-entry ${r.points > 0 ? "reason-add" : "reason-take"}">
            ${r.text}
            <div class="reason-time">${r.time || ""}</div>
          </div>
        `).join("")}
      </div>
    `;
    grid.appendChild(card);
  });
}
</script>

</body>
</html>
