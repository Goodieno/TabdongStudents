<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÌïôÍ∏â Ï†êÏàòÌåê (ÌïôÏÉùÏö©)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ================= BASE ================= */
body {
  font-family: Arial, sans-serif;
  padding: 14px;
  background: #f9fafb;
  transition: background 0.6s ease;
}
h1, h2 {
  margin-bottom: 14px;
  font-size: clamp(20px, 4vw, 28px);
}
ul { list-style: none; padding: 0; }
li { margin: 14px 0; }

/* Links */
button.link-btn {
  background: none;
  border: none;
  color: #2563eb;
  font-size: 18px;
  cursor: pointer;
}
button.link-btn:hover { text-decoration: underline; }

/* ================= RANK BADGES ================= */
.rank-badge {
  display: inline-block;
  margin: 6px 6px 0 0;
  font-weight: bold;
  white-space: nowrap;
}
.rank-1 { color: #ca8a04; }
.rank-2 { color: #6b7280; }
.rank-3 { color: #92400e; }

/* ================= GRID ================= */
.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
}
@media (min-width: 768px) {
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    max-width: 1000px;
  }
}

/* ================= CARDS ================= */
.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 14px;
}
.class-name {
  font-weight: bold;
  color: #2563eb;
  font-size: 18px;
}
.points {
  float: right;
  font-weight: bold;
  font-size: 20px;
  color: #facc15;
  -webkit-text-stroke: 1px #000;
  text-shadow: 1px 1px 0 #000;
}

/* ================= REASONS ================= */
.reasons {
  margin-top: 10px;
  max-height: 180px;
  overflow-y: auto;
  background: #f9fafb;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 10px;
}
.reason { font-weight: bold; margin-bottom: 8px; }
.reason.plus { color: #15803d; }
.reason.minus { color: #b91c1c; }
.reason-time {
  font-size: 12px;
  color: #555;
  font-weight: normal;
}

/* ================= SEASON THEMES ================= */
body.winter { background: linear-gradient(#e0f2fe, #f8fafc); }
body.spring { background: linear-gradient(#fdf2f8, #f0fdf4); }
body.summer { background: linear-gradient(#fefce8, #ecfeff); }
body.fall   { background: linear-gradient(#fff7ed, #fef2f2); }

/* ================= ANIMATIONS ================= */
.season-fx {
  pointer-events: none;
  position: fixed;
  inset: 0;
  overflow: hidden;
  z-index: 0;
}
.fx {
  position: absolute;
  top: -10%;
  animation: fall linear infinite;
  opacity: 0.8;
}
@keyframes fall {
  to { transform: translateY(110vh); }
}
.snow { color: #e5e7eb; font-size: 14px; }
.petal { color: #f9a8d4; }
.leaf { color: #f59e0b; }
.sun { color: #facc15; }

/* Ensure content above animation */
#home, #view { position: relative; z-index: 2; }
</style>
</head>

<body>

<div class="season-fx" id="fx"></div>

<div id="home">
  <h1>ÌïôÎÖÑ ÏÑ†ÌÉù</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
});
const db = firebase.database();

let grades = {};
let currentGrade = null;

/* ================= SEASON DETECTION ================= */
function getSeason() {
  const m = new Date().getMonth() + 1;
  if (m === 12 || m <= 2) return "winter";
  if (m <= 5) return "spring";
  if (m <= 8) return "summer";
  return "fall";
}

function applySeason() {
  const season = getSeason();
  document.body.classList.add(season);
  const fx = document.getElementById("fx");

  const symbols = {
    winter: { char: "‚ùÑ", class: "snow" },
    spring: { char: "üå∏", class: "petal" },
    summer: { char: "‚òÄ", class: "sun" },
    fall:   { char: "üçÇ", class: "leaf" }
  }[season];

  for (let i = 0; i < 20; i++) {
    const span = document.createElement("span");
    span.className = "fx " + symbols.class;
    span.textContent = symbols.char;
    span.style.left = Math.random() * 100 + "%";
    span.style.animationDuration = 8 + Math.random() * 10 + "s";
    span.style.fontSize = 14 + Math.random() * 20 + "px";
    fx.appendChild(span);
  }
}
applySeason();

/* ================= RANK LOGIC ================= */
function getRanks(classes) {
  const valid = Object.entries(classes || {})
    .map(([n,d])=>({name:n,points:d.points||0}))
    .filter(c=>c.points>0);

  if (!valid.length) return [];

  valid.sort((a,b)=>b.points-a.points);
  const groups = {};
  valid.forEach(c=>{
    groups[c.points]=groups[c.points]||[];
    groups[c.points].push(c.name);
  });

  return Object.keys(groups)
    .sort((a,b)=>b-a)
    .slice(0,3)
    .map((p,i)=>({
      rank:i+1,
      classes:groups[p],
      tie:groups[p].length>1
    }));
}

/* ================= DATA ================= */
db.ref("grades").on("value", snap=>{
  grades = snap.val() || {};
  currentGrade ? renderGrade(currentGrade) : renderHome();
});

/* ================= HOME ================= */
function renderHome(){
  currentGrade=null;
  document.getElementById("view").innerHTML="";
  document.getElementById("home").style.display="block";

  const ul=document.getElementById("grade-links");
  ul.innerHTML="";

  for(const g in grades){
    const li=document.createElement("li");
    li.innerHTML=`<button class="link-btn" data-grade="${g}">${g}</button><br>`;

    getRanks(grades[g]).forEach(r=>{
      const medal = r.rank===1?"ü•á":r.rank===2?"ü•à":"ü•â";
      const glove = r.tie ? "ü•ä" : "";
      const span=document.createElement("span");
      span.className=`rank-badge rank-${r.rank}`;
      span.textContent=`${medal}${glove} ${r.classes.join(", ")}`;
      li.appendChild(span);
    });

    ul.appendChild(li);
  }
}

/* ================= GRADE PAGE ================= */
function renderGrade(g){
  currentGrade=g;
  document.getElementById("home").style.display="none";

  const view=document.getElementById("view");
  view.innerHTML=`<button class="link-btn" id="back">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button><h2>${g}</h2><div class="grid"></div>`;

  const grid=view.querySelector(".grid");
  for(const c in grades[g]){
    const d=grades[g][c];
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<div><span class="class-name">${c}</span><span class="points">${d.points||0}</span></div><div class="reasons"></div>`;
    const rbox=card.querySelector(".reasons");

    (d.reasons||[]).slice().reverse().forEach(r=>{
      const div=document.createElement("div");
      div.className="reason "+(r.text.includes("+2")?"plus":"minus");
      div.innerHTML=`${r.text}<div class="reason-time">${r.time}</div>`;
      rbox.appendChild(div);
    });
    grid.appendChild(card);
  }
}

/* ================= EVENTS ================= */
document.addEventListener("click",e=>{
  if(e.target.dataset.grade) renderGrade(e.target.dataset.grade);
  if(e.target.id==="back") renderHome();
});
</script>

</body>
</html>
