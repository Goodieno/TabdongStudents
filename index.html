<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÌïôÍ∏â Ï†êÏàòÌåê (ÌïôÏÉùÏö©)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  padding: 14px;
  background: #f9fafb;
  overflow-x: hidden;
}

h1, h2 {
  margin-bottom: 14px;
  font-size: clamp(20px, 4vw, 28px);
}

ul { list-style: none; padding: 0; }
li { margin: 14px 0; }

/* Links */
button.link-btn {
  background: none;
  border: none;
  color: #2563eb;
  font-size: 18px;
  cursor: pointer;
  padding: 6px 4px;
}
button.link-btn:hover { text-decoration: underline; }

/* Grid ‚Äî MAX 3 columns */
.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
}
@media (min-width: 640px) {
  .grid { grid-template-columns: repeat(2, minmax(260px, 1fr)); }
}
@media (min-width: 1024px) {
  .grid { grid-template-columns: repeat(3, minmax(260px, 1fr)); }
}

/* Cards */
.card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 14px;
  padding: 14px;
}

.class-name {
  font-weight: bold;
  color: #2563eb;
  font-size: 18px;
}

/* Points */
.points {
  float: right;
  font-weight: bold;
  font-size: 22px;
  color: #facc15;
  -webkit-text-stroke: 1px #000;
  text-shadow: 1px 1px 0 #000;
}

/* Reasons */
.reasons {
  margin-top: 10px;
  max-height: 180px;
  overflow-y: auto;
  background: #f9fafb;
  border: 1px solid #ddd;
  padding: 10px;
  border-radius: 10px;
}

.reason {
  font-size: 15px;
  margin-bottom: 8px;
  font-weight: bold;
}
.reason.plus { color: #15803d; }
.reason.minus { color: #b91c1c; }

.reason-time {
  font-size: 12px;
  color: #555;
  font-weight: normal;
}

/* Seasonal overlay */
#season-overlay {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
}

/* Snow */
.snowflake {
  position: absolute;
  color: #fff;
  opacity: 0.95;
  text-shadow: 0 0 4px rgba(0,0,0,0.4);
  animation: fall linear infinite;
}
@keyframes fall {
  from { transform: translateY(-10vh); }
  to { transform: translateY(110vh); }
}

/* Petals / Leaves / Orbs */
.float {
  position: absolute;
  opacity: 0.9;
  animation: drift linear infinite;
}
@keyframes drift {
  from { transform: translateY(-10vh) rotate(0deg); }
  to { transform: translateY(110vh) rotate(360deg); }
}
</style>
</head>

<body>

<div id="season-overlay"></div>

<div id="home">
  <h1>ÌïôÎÖÑ ÏÑ†ÌÉù</h1>
  <ul id="grade-links"></ul>
</div>

<div id="view"></div>

<script>
/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyAfFbHdfoXoOLw7rD-nd8HPSaZR6OBBYf8",
  authDomain: "tally-v-2.firebaseapp.com",
  databaseURL: "https://tally-v-2-default-rtdb.firebaseio.com",
  projectId: "tally-v-2",
  storageBucket: "tally-v-2.appspot.com",
  messagingSenderId: "193194015446",
  appId: "1:193194015446:web:41f010ef36a74df776a777"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let grades = {};
let currentGrade = null;

/* ===== SEASON & HOLIDAY DETECTION ===== */
function getTheme() {
  const d = new Date();
  const m = d.getMonth() + 1;
  const day = d.getDate();

  // Fixed Korean holidays
  if (m === 3 && day === 1) return "korea";
  if (m === 5 && day === 5) return "kids";
  if (m === 6 && day === 6) return "memorial";
  if (m === 8 && day === 15) return "korea";
  if (m === 10 && day === 9) return "hangul";
  if (m === 12 && day === 25) return "christmas";

  // Lunar ranges (adjust yearly)
  if (m === 2 && day >= 8 && day <= 11) return "newyear";
  if (m === 9 && day >= 15 && day <= 18) return "chuseok";

  // Seasons
  if (m === 12 || m <= 2) return "winter";
  if (m <= 5) return "spring";
  if (m <= 8) return "summer";
  return "fall";
}

/* ===== THEME EFFECTS ===== */
const theme = getTheme();
const overlay = document.getElementById("season-overlay");

function spawn(icon, count, sizeMin, sizeMax, speedMin, speedMax) {
  for (let i = 0; i < count; i++) {
    const el = document.createElement("div");
    el.className = icon === "‚ùÑ" ? "snowflake" : "float";
    el.textContent = icon;
    el.style.left = Math.random() * 100 + "vw";
    el.style.fontSize = sizeMin + Math.random() * (sizeMax - sizeMin) + "px";
    el.style.animationDuration = speedMin + Math.random() * (speedMax - speedMin) + "s";
    overlay.appendChild(el);
  }
}

if (theme === "winter" || theme === "christmas") spawn("‚ùÑ", 35, 16, 30, 8, 16);
if (theme === "spring") spawn("üå∏", 25, 18, 28, 10, 18);
if (theme === "summer") spawn("‚òÄÔ∏è", 15, 20, 32, 14, 22);
if (theme === "fall" || theme === "chuseok") spawn("üçÅ", 25, 18, 30, 10, 18);
if (theme === "kids") spawn("üéà", 20, 20, 30, 10, 18);

/* ===== DATA ===== */
db.ref("grades").on("value", snap => {
  grades = snap.val() || {};
  currentGrade ? renderGrade(currentGrade) : renderHome();
});

/* ===== HOME ===== */
function renderHome() {
  currentGrade = null;
  document.getElementById("view").innerHTML = "";
  document.getElementById("home").style.display = "block";

  const ul = document.getElementById("grade-links");
  ul.innerHTML = "";

  for (const grade in grades) {
    const li = document.createElement("li");
    li.innerHTML = `<button class="link-btn" data-grade="${grade}">${grade}</button>`;
    ul.appendChild(li);
  }
}

/* ===== GRADE ===== */
function renderGrade(grade) {
  currentGrade = grade;
  document.getElementById("home").style.display = "none";

  const view = document.getElementById("view");
  view.innerHTML = `
    <button class="link-btn" id="back">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
    <h2>${grade} Ï†êÏàò</h2>
    <div class="grid"></div>
  `;

  const grid = view.querySelector(".grid");
  const classes = grades[grade] || {};

  for (const name in classes) {
    const d = classes[name];
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div>
        <span class="class-name">${name}</span>
        <span class="points">${d.points || 0}</span>
      </div>
      <div class="reasons"></div>
    `;

    const reasons = card.querySelector(".reasons");
    (d.reasons || []).slice().reverse().forEach(r => {
      const div = document.createElement("div");
      div.className = "reason " + (r.text.includes("+2") ? "plus" : "minus");
      div.innerHTML = `${r.text}<div class="reason-time">${r.time}</div>`;
      reasons.appendChild(div);
    });

    grid.appendChild(card);
  }
}

/* ===== EVENTS ===== */
document.addEventListener("click", e => {
  if (e.target.dataset.grade) renderGrade(e.target.dataset.grade);
  if (e.target.id === "back") renderHome();
});
</script>

</body>
</html>
